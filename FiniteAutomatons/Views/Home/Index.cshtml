@model AutomatonViewModel
@{
    ViewData["Title"] = "Home";
    var hasExecuted = Model != null && Model.HasExecuted;
    var inputLen = Model?.Input?.Length ?? 0;
    var atStartPos = hasExecuted && Model!.Position <= 0;
    var atEndPos = hasExecuted && Model!.Position >= inputLen && inputLen > 0;
    var disableAllUntilStart = Model == null || !hasExecuted; // initial state before Start
    var analysis = ViewData["MinimizationAnalysis"] as FiniteAutomatons.Services.Interfaces.MinimizationAnalysis;
}
<div class="automaton-workspace">
    <!-- Global messages (conversion / errors) -->
    @if (TempData["ErrorMessage"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="alert alert-error minimization-alert" data-test="error-message">@err</div>
    }
    @if (TempData["ConversionMessage"] is string conv && !string.IsNullOrWhiteSpace(conv))
    {
        <div class="alert alert-info minimization-alert" data-test="conversion-message">@conv</div>
    }
    <!-- Main Content Area -->
    <div class="workspace-grid">
        <!-- Left Section - Create Automaton -->
        <div class="create-section">
            <div class="section-header">
                <h2>AUTOMATON</h2>
                <button id="panelsLockBtn" class="panel-lock-btn" title="Lock / unlock panels" aria-pressed="false" type="button">
                    <i class="fas fa-lock-open"></i>
                </button>
            </div>
            <div class="create-content">
                <style>
                    /* Small styles for draggable panels */
                    /* Place lock inline with header title */
                    .create-section > .section-header { display: flex; align-items: center; gap: 0.5rem; justify-content: center; white-space: nowrap; }
                    .create-section > .section-header h2 { margin: 0; }
                    .panel-lock-btn { background:transparent;border:0;color:var(--bs-body-color);cursor:pointer;font-size:0.95rem;padding:0 }
                    .panel-lock-btn i { font-size:1.05rem; display:block }
                    .automaton-detail-section[draggable="true"] { cursor: move; }
                    .automaton-detail-section.dragging { opacity:0.6; }
                    .automaton-detail-section.locked { cursor: default; }
                </style>

                <div class="input-area" id="panelContainer">
                    @if (Model != null)
                    {
                        <!-- Alphabet Section -->
                        <div class="automaton-detail-section" data-panel-id="alphabet">
                            <h4>Alphabet</h4>
                            <div class="alphabet-display">
                                @if (Model.Alphabet != null && Model.Alphabet.Count > 0)
                                {
                                    <span class="alphabet-symbols">{ @string.Join(", ", Model.Alphabet.Select(c => c == '\0' ? "ε" : c.ToString())) }</span>
                                }
                                else
                                {
                                    <span class="placeholder-text">No symbols defined</span>
                                }
                            </div>
                        </div>

                        <!-- States Section -->
                        <div class="automaton-detail-section" data-panel-id="states">
                            <h4>States</h4>
                            <div class="states-display">
                                @if (Model.States != null && Model.States.Count > 0)
                                {
                                    <ul class="states-list">
                                        @foreach (var state in Model.States.OrderBy(s => s.Id))
                                        {
                                            var isActive = (Model.CurrentStates != null && Model.CurrentStates.Contains(state.Id)) || (Model.CurrentStateId == state.Id);
                                            <li class="state-item @(isActive ? "state-active" : "")" data-state-id="@state.Id">
                                                <span class="state-id">q@(state.Id)</span>
                                                @if (state.IsStart)
                                                {
                                                    <span class="state-badge badge-start">Start</span>
                                                }
                                                @if (state.IsAccepting)
                                                {
                                                    <span class="state-badge badge-accepting">Accepting</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <span class="placeholder-text">No states defined</span>
                                }
                            </div>
                        </div>

                        <!-- Transitions Section -->
                        <div class="automaton-detail-section" data-panel-id="transitions">
                            <h4>Transitions</h4>
                            <div class="transitions-display">
                                @if (Model.Transitions != null && Model.Transitions.Count > 0)
                                {
                                    <ul class="transitions-list">
                                        @foreach (var transition in Model.Transitions.OrderBy(t => t.FromStateId).ThenBy(t => t.Symbol).ThenBy(t => t.ToStateId))
                                        {
                                            <li class="transition-item" data-from="@transition.FromStateId" data-to="@transition.ToStateId" data-symbol="@(transition.Symbol == '\0' ? "" : transition.Symbol.ToString())">
                                                @if (Model.Type == AutomatonType.PDA)
                                                {
                                                    <span class="transition-text">
                                                        q@(transition.FromStateId) -- @(transition.Symbol == '\0' ? "ε" : transition.Symbol.ToString()) \
                                                        / @(transition.StackPop.HasValue ? (transition.StackPop.Value == '\0' ? "ε" : transition.StackPop.Value.ToString()) : "-")
                                                        -> @(string.IsNullOrEmpty(transition.StackPush) ? "-" : transition.StackPush) -> q@(transition.ToStateId)
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="transition-text">q@(transition.FromStateId) -- @(transition.Symbol == '\0' ? "ε" : transition.Symbol.ToString()) -> q@(transition.ToStateId)</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <span class="placeholder-text">No transitions defined</span>
                                }
                            </div>
                        </div>

                        <!-- Minimization Mapping Section (raw report only) -->
                        @if (!string.IsNullOrEmpty(Model.MinimizationReport))
                        {
                            <div class="automaton-detail-section minimization-section" data-panel-id="minimization">
                                <h4>Minimization Mapping</h4>
                                <div class="minimization-content">
                                    <pre class="minimization-report">@Model.MinimizationReport</pre>
                                </div>
                            </div>
                        }

                        <!-- Execution State Section (Debug Info) -->
                        @if (Model.HasExecuted || Model.Position > 0 || Model.CurrentStateId.HasValue || (Model.CurrentStates != null && Model.CurrentStates.Count > 0))
                        {
                            <div class="automaton-detail-section execution-state-section" data-panel-id="execution">
                                <h4>Execution State</h4>
                                <div class="execution-state-display">
                                    <div class="execution-state-item">
                                        <span class="execution-label">Current Position:</span>
                                        <span class="execution-value">@Model.Position / @(Model.Input?.Length ?? 0)</span>
                                    </div>

                                    @if (Model.Type == AutomatonType.DFA || Model.Type == AutomatonType.PDA)
                                    {
                                        <div class="execution-state-item">
                                            <span class="execution-label">Current State:</span>
                                            <span class="execution-value">
                                                @if (Model.CurrentStateId.HasValue)
                                                {
                                                    <span class="state-highlight">@($"q{Model.CurrentStateId}")</span>
                                                }
                                                else
                                                {
                                                    <span class="placeholder-text">-</span>
                                                }
                                            </span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="execution-state-item">
                                            <span class="execution-label">Current States:</span>
                                            <span class="execution-value">
                                                @if (Model.CurrentStates != null && Model.CurrentStates.Count > 0)
                                                {
                                                    <span class="state-highlight">{ @string.Join(", ", Model.CurrentStates.OrderBy(s => s).Select(s => "q" + s)) }</span>
                                                }
                                                else
                                                {
                                                    <span class="placeholder-text">-</span>
                                                }
                                            </span>
                                        </div>
                                    }

                                    <div class="execution-state-item">
                                        <span class="execution-label">Next Symbol:</span>
                                        <span class="execution-value">
                                            @if (!string.IsNullOrEmpty(Model.Input) && Model.Position < Model.Input.Length)
                                            {
                                                <span class="symbol-highlight">'@Model.Input[Model.Position]'</span>
                                            }
                                            else
                                            {
                                                <span class="placeholder-text">End of input</span>
                                            }
                                        </span>
                                    </div>

                                    @* Show Result when input is fully read *@
                                    @if (Model.Position >= (Model.Input?.Length ?? 0) && Model.IsAccepted.HasValue)
                                    {
                                        <div class="execution-state-item result-highlight">
                                            <span class="execution-label">Result:</span>
                                            <span class="execution-value">
                                                @if (Model.IsAccepted.Value)
                                                {
                                                    <span class="result-badge result-accepted">✓ ACCEPTED</span>
                                                }
                                                else
                                                {
                                                    <span class="result-badge result-rejected">✗ REJECTED</span>
                                                }
                                            </span>
                                        </div>
                                    }

                                    <div class="execution-state-item">
                                        <span class="execution-label">Is Accepted:</span>
                                        <span class="execution-value">
                                            @if (Model.IsAccepted.HasValue)
                                            {
                                                if (Model.IsAccepted.Value)
                                                {
                                                    <span class="acceptance-status accepted">✓ Accepted</span>
                                                }
                                                else
                                                {
                                                    <span class="acceptance-status rejected">✗ Rejected</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="acceptance-status pending">⧗ Pending</span>
                                            }
                                        </span>
                                    </div>

                                    @if (Model.Type == AutomatonType.PDA && !string.IsNullOrEmpty(Model.StackSerialized))
                                    {
                                        <div class="execution-state-item">
                                            <span class="execution-label">Stack:</span>
                                            <span class="execution-value stack-value">
                                                @try
                                                {
                                                    var stack = System.Text.Json.JsonSerializer.Deserialize<List<char>>(Model.StackSerialized);
                                                    if (stack != null && stack.Count > 0)
                                                    {
                                                        <span class="stack-highlight">[ @string.Join(", ", stack.Select(c => c == '\0' ? "ε" : c.ToString())) ]</span>
                                                        <span class="stack-hint">(top first)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="placeholder-text">Empty</span>
                                                    }
                                                }
                                                catch
                                                {
                                                    <span class="placeholder-text">-</span>
                                                }
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="placeholder-text">No automaton loaded</p>
                    }
                </div>
            </div>
        </div>

        <!-- Right Section - Graph Canvas -->
        <div class="graph-section">
            <div class="section-header">
                <h2>GRAPH</h2>
            </div>
            <div class="graph-content">
                <canvas id="automatonCanvas" class="automaton-canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Bottom Control Sections -->
    <form asp-controller="Automaton" method="post" id="automatonForm">
        @if (Model != null)
        {
            <input type="hidden" asp-for="Type" />
            <input type="hidden" asp-for="HasExecuted" />
            <input type="hidden" asp-for="Position" />
            <input type="hidden" asp-for="CurrentStateId" />
            <input type="hidden" asp-for="IsAccepted" />
            <input type="hidden" asp-for="StateHistorySerialized" />
            <input type="hidden" asp-for="StackSerialized" />
            <input type="hidden" asp-for="IsCustomAutomaton" />
            <input type="hidden" name="targetType" id="targetTypeField" />
            @if (Model.States != null)
            {
                @for (int i = 0; i < Model.States.Count; i++)
                {
                    <input type="hidden" name="States.Index" value="@i" />
                    <input type="hidden" name="States[@i].Id" value="@Model.States[i].Id" />
                    <input type="hidden" name="States[@i].IsStart" value="@Model.States[i].IsStart.ToString().ToLowerInvariant()" />
                    <input type="hidden" name="States[@i].IsAccepting" value="@Model.States[i].IsAccepting.ToString().ToLowerInvariant()" />
                }
            }
            @if (Model.Transitions != null)
            {
                @for (int i = 0; i < Model.Transitions.Count; i++)
                {
                    <input type="hidden" name="Transitions.Index" value="@i" />
                    <input type="hidden" name="Transitions[@i].FromStateId" value="@Model.Transitions[i].FromStateId" />
                    <input type="hidden" name="Transitions[@i].ToStateId" value="@Model.Transitions[i].ToStateId" />
                    <input type="hidden" name="Transitions[@i].Symbol" value="@Model.Transitions[i].Symbol" />
                }
            }
            @if (Model.CurrentStates != null)
            {
                @for (int i = 0; i < Model.CurrentStates.Count; i++)
                {
                    <input type="hidden" name="CurrentStates.Index" value="@i" />
                    <input type="hidden" name="CurrentStates[@i]" value="@Model.CurrentStates.ElementAt(i)" />
                }
            }
        }

        <div class="control-sections">
            <!-- Input Section -->
            <div class="control-section input-section">
                <div class="section-header-custom">
                    <h2>INPUT</h2>
                </div>
                <div class="control-content-left">
                    <input type="text" class="input-field" name="Input" id="inputField"
                       placeholder="Enter input string..."
                       value="@(Model != null ? Model.Input : "")"
                       @(Model != null && Model.HasExecuted ? "readonly" : "") />
                </div>
            </div>

            <!-- Simulate Section -->
            <div class="control-section simulate-section">
                <div class="section-header-custom">
                    <h2>SIMULATE</h2>
                </div>
                <div class="control-content simulate-buttons">
                    @* Start / Reset *@
                    @if (!hasExecuted)
                    {
                        <button type="submit" class="control-btn simulate-btn"
                                asp-controller="AutomatonExecution" asp-action="Start"
                                title="Start" data-sim-primary="start">
                            <i class="fas fa-play-circle"></i>
                            <span>Start</span>
                        </button>
                    }
                    @if (hasExecuted)
                    {
                        <button type="submit" class="control-btn simulate-btn"
                                asp-controller="AutomatonExecution" asp-action="Reset"
                                title="Reset" data-sim-primary="reset">
                            <i class="fas fa-undo"></i>
                            <span>Reset</span>
                        </button>
                    }

                    @* BackToStart *@
                    @if (disableAllUntilStart || atStartPos)
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="BackToStart" title="Back to start" data-sim-action="backToStart" disabled>
                            <i class="fas fa-undo"></i>
                            <span>Back to start</span>
                        </button>
                    }
                    else
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="BackToStart" title="Back to start" data-sim-action="backToStart">
                            <i class="fas fa-undo"></i>
                            <span>Back to start</span>
                        </button>
                    }

                    @* StepBackward *@
                    @if (disableAllUntilStart || atStartPos)
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="StepBackward" title="Step back" data-sim-action="stepBackward" disabled>
                            <i class="fas fa-step-backward"></i>
                            <span>Step back</span>
                        </button>
                    }
                    else
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="StepBackward" title="Step back" data-sim-action="stepBackward">
                            <i class="fas fa-step-backward"></i>
                            <span>Step back</span>
                        </button>
                    }

                    @* StepForward *@
                    @if (disableAllUntilStart || atEndPos)
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="StepForward" title="Read next" data-sim-action="stepForward" disabled>
                            <i class="fas fa-step-forward"></i>
                            <span>Read next</span>
                        </button>
                    }
                    else
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="StepForward" title="Read next" data-sim-action="stepForward">
                            <i class="fas fa-step-forward"></i>
                            <span>Read next</span>
                        </button>
                    }

                    @* ExecuteAll *@
                    @if (disableAllUntilStart || atEndPos)
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="ExecuteAll" title="Read all" data-sim-action="executeAll" disabled>
                            <i class="fas fa-forward"></i>
                            <span>Read all</span>
                        </button>
                    }
                    else
                    {
                        <button type="submit" class="control-btn simulate-btn" asp-controller="AutomatonExecution" asp-action="ExecuteAll" title="Read all" data-sim-action="executeAll">
                            <i class="fas fa-forward"></i>
                            <span>Read all</span>
                        </button>
                    }
                </div>
            </div>

            <!-- Automaton Type Section -->
            <div class="control-section type-section">
                <div class="section-header-custom">
                    <h2>AUTOMATON TYPE</h2>
                </div>
                <div class="control-content type-buttons">
                    <button type="button" class="control-btn type-btn @(Model != null && Model.Type == AutomatonType.DFA ? "active" : "")" data-type="DFA">DFA</button>
                    <button type="button" class="control-btn type-btn @(Model != null && Model.Type == AutomatonType.NFA ? "active" : "")" data-type="NFA">NFA</button>
                    <button type="button" class="control-btn type-btn @(Model != null && Model.Type == AutomatonType.EpsilonNFA ? "active" : "")" data-type="EpsilonNFA">ε-NFA</button>
                    <button type="button" class="control-btn type-btn @(Model != null && Model.Type == AutomatonType.PDA ? "active" : "")" data-type="PDA">PDA</button>
                </div>
            </div>
            @if (Model?.Type == AutomatonType.DFA && analysis != null && analysis.SupportsMinimization)
            {
            <!-- Minimalize Section -->
            <div class="control-section minimize-section">
                <div class="section-header-custom">
                    <h2>MINIMALIZE</h2>
                </div>
                <div class="control-content-right">
                        @{
                            // Ensure this is evaluated as Razor code so the local variable is available to subsequent Razor logic.
                        var executionStarted = Model.HasExecuted || Model.Position > 0;
                        }
                        @if (analysis.IsMinimal)
                        {
                            <button type="button" class="control-btn minimize-btn" disabled title="Already minimal">
                                Minimalize (Already Minimal)
                            </button>
                        }
                        else if (executionStarted)
                        {
                            <button type="button" class="control-btn minimize-btn" disabled title="Execution started">
                                Minimalize (Disabled - Execution Started)
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="control-btn minimize-btn"
                                    asp-controller="AutomatonExecution" asp-action="Minimalize" title="Minimalize DFA">
                                Minimalize (→ @analysis.MinimizedStateCount)
                            </button>
                    }
                </div>
            </div>
            }
        </div>
    </form>
    <div class="control-sections">
        <div class="control-section input-section" style="margin-top: 1rem;">
            <div class="section-header-custom">
                <h2 style="margin:0;">GENERATE</h2>
            </div>
            <div class="control-content-left" style="text-align:center; margin-bottom:0.5rem;">
                <button id="generateModalBtn" class="control-btn" type="button">
                    <i class="fas fa-random"></i>
                    <span>Generate Automaton</span>
                </button>
            </div>

            <!-- Modal markup -->
            <div id="generateModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="modal-close" id="generateModalClose">&times;</span>
                    <h3>Generate Automaton</h3>
                    <div class="preset-buttons">
                        <form asp-controller="AutomatonPreset" asp-action="GeneratePreset" method="post" style="display:inline-block; margin:0.25rem;">
                            <input type="hidden" name="preset" value="minimalized-dfa" />
                            <button type="submit" class="control-btn">Minimalized DFA</button>
                        </form>
                        <form asp-controller="AutomatonPreset" asp-action="GeneratePreset" method="post" style="display:inline-block; margin:0.25rem;">
                            <input type="hidden" name="preset" value="unminimalized-dfa" />
                            <button type="submit" class="control-btn">DFA (un-minimalized)</button>
                        </form>
                        <form asp-controller="AutomatonPreset" asp-action="GeneratePreset" method="post" style="display:inline-block; margin:0.25rem;">
                            <input type="hidden" name="preset" value="nfa" />
                            <button type="submit" class="control-btn">NFA</button>
                        </form>
                        <form asp-controller="AutomatonPreset" asp-action="GeneratePreset" method="post" style="display:inline-block; margin:0.25rem;">
                            <input type="hidden" name="preset" value="epsilon-nfa" />
                            <button type="submit" class="control-btn">ε-NFA</button>
                        </form>
                    </div>

                    <div class="divider" style="margin:1rem 0; border-top:1px solid #ddd;"></div>

                    <div>
                        <a href="@Url.Action("GenerateRandomAutomaton", "AutomatonGeneration")" class="control-btn">Generate Random Automaton</a>
                    </div>

                    <div class="accordion" style="margin-top:1rem;">
                        <button class="accordion-toggle control-btn" type="button">Generate by parameters</button>
                        <div class="accordion-panel" style="display:none; margin-top:0.5rem;">
                            <form asp-controller="AutomatonGeneration" asp-action="GenerateRandomAutomaton" method="post">
                                <label>Type:</label>
                                <select name="Type">
                                    <option value="0">DFA</option>
                                    <option value="1">NFA</option>
                                    <option value="2">ε-NFA</option>
                                    <option value="3">PDA</option>
                                </select>
                                <label>States:</label>
                                <input type="number" name="StateCount" value="5" min="1" max="20" />
                                <label>Transitions:</label>
                                <input type="number" name="TransitionCount" value="8" min="0" />
                                <label>Alphabet size:</label>
                                <input type="number" name="AlphabetSize" value="3" min="1" max="10" />
                                <label>Accepting ratio:</label>
                                <input type="number" step="0.05" name="AcceptingStateRatio" value="0.3" min="0" max="1" />
                                <div style="margin-top:0.5rem;">
                                    <button type="submit" class="control-btn">Generate</button>
                                </div>
                            </form>
                        </div>

                        <button class="accordion-toggle control-btn" type="button" style="margin-top:0.5rem;">Create fully custom automaton</button>
                        <div class="accordion-panel" style="display:none; margin-top:0.5rem;">
                            <a class="control-btn" href="@Url.Action("CreateAutomaton", "Automaton")">Open automaton creator</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="control-section">
            <div class="section-header-custom">
                <h2>PLACEHOLDER</h2>
            </div>
        </div>

        <div class="control-section">
            <div class="section-header-custom">
                <h2>PLACEHOLDER</h2>
            </div>
        </div>
        <div class="control-section">
            <div class="section-header-custom">
                <h2>PLACEHOLDER</h2>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script src="~/js/canvas.js" asp-append-version="true"></script>
    <script type="module" src="~/js/inputOverlay.mjs" asp-append-version="true"></script>
    <script type="module" src="~/js/panelHighlighter.mjs" asp-append-version="true"></script>
    <script type="module" src="~/js/home.mjs" asp-append-version="true"></script>
    <script type="module" src="~/js/simulateControls.mjs" asp-append-version="true"></script>
    <script type="module" src="~/js/automatonTypeControls.mjs" asp-append-version="true"></script>
    <script src="~/js/generateModal.js" asp-append-version="true"></script>
}
