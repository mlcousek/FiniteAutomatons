@model AutomatonViewModel
@{
    ViewData["Title"] = "Create Automaton";
}

<div class="automaton-workspace">
    <!-- Global messages (validation errors) -->
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-error" data-test="error-message">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <div>@error.ErrorMessage</div>
            }
        </div>
    }

    <!-- Main Content Area -->
    <div class="workspace-grid">
        <!-- Left Section - Automaton Details -->
        <div class="create-section">
            <div class="section-header">
                <h2>AUTOMATON</h2>
            </div>
            <div class="create-content">
                <div class="input-area">
                    @if (Model != null)
                    {
                        <!-- Alphabet Section -->
                        <div class="automaton-detail-section">
                            <h4>Alphabet</h4>
                            <div class="alphabet-display">
                                @if (Model.Alphabet != null && Model.Alphabet.Count > 0)
                                {
                                    <span class="alphabet-symbols">{ @string.Join(", ", Model.Alphabet.Select(c => c == '\0' ? "ε" : c.ToString())) }</span>
                                }
                                else
                                {
                                    <span class="placeholder-text">No symbols defined (will be derived from transitions)</span>
                                }
                            </div>
                        </div>

                        <!-- States Section -->
                        <div class="automaton-detail-section">
                            <h4>States (@(Model.States?.Count ?? 0))</h4>
                            <div class="states-display">
                                @if (Model.States != null && Model.States.Count > 0)
                                {
                                    <ul class="states-list">
                                        @foreach (var state in Model.States.OrderBy(s => s.Id))
                                        {
                                            <li class="state-item" data-state-id="@state.Id">
                                                <span class="state-id">q@(state.Id)</span>
                                                @if (state.IsStart)
                                                {
                                                    <span class="state-badge badge-start">Start</span>
                                                }
                                                @if (state.IsAccepting)
                                                {
                                                    <span class="state-badge badge-accepting">Accepting</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <span class="placeholder-text">No states defined - add states below</span>
                                }
                            </div>
                        </div>

                        <!-- Transitions Section -->
                        <div class="automaton-detail-section">
                            <h4>Transitions (@(Model.Transitions?.Count ?? 0))</h4>
                            <div class="transitions-display">
                                @if (Model.Transitions != null && Model.Transitions.Count > 0)
                                {
                                    <ul class="transitions-list">
                                        @foreach (var transition in Model.Transitions.OrderBy(t => t.FromStateId).ThenBy(t => t.Symbol).ThenBy(t => t.ToStateId))
                                        {
                                            <li class="transition-item">
                                                @if (Model.Type == AutomatonType.PDA)
                                                {
                                                    <span class="transition-text">
                                                        q@(transition.FromStateId) -- @(transition.Symbol == '\0' ? 'ε' : transition.Symbol.ToString()) \
                                                        / @(transition.StackPop.HasValue ? (transition.StackPop.Value == '\0' ? 'ε' : transition.StackPop.Value.ToString()) : "-")
                                                        -> @(string.IsNullOrEmpty(transition.StackPush) ? "-" : transition.StackPush) -> q@(transition.ToStateId)
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="transition-text">q@(transition.FromStateId) -- @(transition.Symbol == '\0' ? 'ε' : transition.Symbol.ToString()) -> q@(transition.ToStateId)</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <span class="placeholder-text">No transitions defined - add transitions below</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Section - Graph Canvas -->
        <div class="graph-section">
            <div class="section-header">
                <h2>GRAPH</h2>
            </div>
            <div class="graph-content">
                <canvas id="automatonCanvas" class="automaton-canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Bottom Control Sections -->
    <div class="control-sections">
        <!-- Automaton Type Section -->
        <div class="control-section type-section">
            <div class="section-header-custom">
                <h2>AUTOMATON TYPE</h2>
            </div>
            <form asp-controller="AutomatonCreation" asp-action="CreateAutomaton" method="post" id="typeForm">
                @Html.HiddenFor(m => m.States)
                @Html.HiddenFor(m => m.Transitions)
                <div class="control-content type-buttons">
                    <button type="submit" class="control-btn type-btn @(Model?.Type == AutomatonType.DFA ? "active" : "")" 
                            onclick="document.getElementById('typeField').value='0'; return true;">DFA</button>
                    <button type="submit" class="control-btn type-btn @(Model?.Type == AutomatonType.NFA ? "active" : "")" 
                            onclick="document.getElementById('typeField').value='1'; return true;">NFA</button>
                    <button type="submit" class="control-btn type-btn @(Model?.Type == AutomatonType.EpsilonNFA ? "active" : "")" 
                            onclick="document.getElementById('typeField').value='2'; return true;">ε-NFA</button>
                    <button type="submit" class="control-btn type-btn @(Model?.Type == AutomatonType.PDA ? "active" : "")" 
                            onclick="document.getElementById('typeField').value='3'; return true;">PDA</button>
                </div>
                <input type="hidden" name="Type" id="typeField" value="@((int)(Model?.Type ?? AutomatonType.DFA))" />
            </form>
        </div>

        <!-- Add State Section -->
        <div class="control-section">
            <div class="section-header-custom">
                <h2>ADD STATE</h2>
            </div>
            <form asp-controller="AutomatonCreation" asp-action="AddState" method="post" style="padding:1rem;">
                @Html.HiddenFor(m => m.Type)
                @if (Model?.States != null)
                {
                    @for (int i = 0; i < Model.States.Count; i++)
                    {
                        <input type="hidden" name="States[@i].Id" value="@Model.States[i].Id" />
                        <input type="hidden" name="States[@i].IsStart" value="@Model.States[i].IsStart.ToString().ToLowerInvariant()" />
                        <input type="hidden" name="States[@i].IsAccepting" value="@Model.States[i].IsAccepting.ToString().ToLowerInvariant()" />
                    }
                }
                @if (Model?.Transitions != null)
                {
                    @for (int i = 0; i < Model.Transitions.Count; i++)
                    {
                        <input type="hidden" name="Transitions[@i].FromStateId" value="@Model.Transitions[i].FromStateId" />
                        <input type="hidden" name="Transitions[@i].ToStateId" value="@Model.Transitions[i].ToStateId" />
                        <input type="hidden" name="Transitions[@i].Symbol" value="@Model.Transitions[i].Symbol" />
                        @if (Model.Type == AutomatonType.PDA)
                        {
                            <input type="hidden" name="Transitions[@i].StackPop" value="@Model.Transitions[i].StackPop" />
                            <input type="hidden" name="Transitions[@i].StackPush" value="@Model.Transitions[i].StackPush" />
                        }
                    }
                }
                <div style="display:flex; flex-direction:column; gap:0.75rem;">
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <label style="min-width:100px; font-weight:600;">State ID:</label>
                        <input type="number" name="stateId" class="control-btn" style="flex:1; padding:0.5rem 0.75rem;" required min="0" />
                    </div>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <label style="min-width:100px; font-weight:600;">
                            <input type="checkbox" name="isStart" value="true" style="margin-right:0.5rem;" />
                            Start State
                        </label>
                    </div>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <label style="min-width:100px; font-weight:600;">
                            <input type="checkbox" name="isAccepting" value="true" style="margin-right:0.5rem;" />
                            Accepting
                        </label>
                    </div>
                    <button type="submit" class="control-btn" style="width:100%; margin-top:0.5rem;">Add State</button>
                </div>
            </form>
        </div>

        <!-- Remove State Section -->
        <div class="control-section">
            <div class="section-header-custom">
                <h2>REMOVE STATE</h2>
            </div>
            <form asp-controller="AutomatonCreation" asp-action="RemoveState" method="post" style="padding:1rem;">
                @Html.HiddenFor(m => m.Type)
                @if (Model?.States != null)
                {
                    @for (int i = 0; i < Model.States.Count; i++)
                    {
                        <input type="hidden" name="States[@i].Id" value="@Model.States[i].Id" />
                        <input type="hidden" name="States[@i].IsStart" value="@Model.States[i].IsStart.ToString().ToLowerInvariant()" />
                        <input type="hidden" name="States[@i].IsAccepting" value="@Model.States[i].IsAccepting.ToString().ToLowerInvariant()" />
                    }
                }
                @if (Model?.Transitions != null)
                {
                    @for (int i = 0; i < Model.Transitions.Count; i++)
                    {
                        <input type="hidden" name="Transitions[@i].FromStateId" value="@Model.Transitions[i].FromStateId" />
                        <input type="hidden" name="Transitions[@i].ToStateId" value="@Model.Transitions[i].ToStateId" />
                        <input type="hidden" name="Transitions[@i].Symbol" value="@Model.Transitions[i].Symbol" />
                        @if (Model.Type == AutomatonType.PDA)
                        {
                            <input type="hidden" name="Transitions[@i].StackPop" value="@Model.Transitions[i].StackPop" />
                            <input type="hidden" name="Transitions[@i].StackPush" value="@Model.Transitions[i].StackPush" />
                        }
                    }
                }
                <div style="display:flex; flex-direction:column; gap:0.75rem;">
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <label style="min-width:100px; font-weight:600;">State ID:</label>
                        <input type="number" name="stateId" class="control-btn" style="flex:1; padding:0.5rem 0.75rem;" required min="0" />
                    </div>
                    <button type="submit" class="control-btn" style="width:100%; margin-top:0.5rem;">Remove State</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Second row of controls -->
    <div class="control-sections">
        <!-- Add Transition Section -->
        <div class="control-section" style="grid-column: span 2;">
            <div class="section-header-custom" style="position:relative; padding-right:2.5rem;">
                <div class="epsilon-info" style="position:absolute; left:0; top:50%; transform:translateY(-50%); display:none;">
                    <span class="info-btn" aria-label="Epsilon info" title="Alt+E: insert ε" style="display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; font-size:1.15rem; color:var(--bs-body-color); background:transparent; border:none; box-shadow:none; cursor:pointer; padding-left:1rem;">
                        <i class="fas fa-info-circle" aria-hidden="true" style="font-size:1.25rem"></i>
                    </span>
                    <div class="info-tooltip" style="display:none; position:absolute; left:calc(100% + 8px); top:50%; transform:translateY(-50%); background:#222; color:#fff; padding:6px 8px; border-radius:4px; white-space:nowrap; font-size:0.85rem;">
                        Alt+E inserts 'ε' when ε-NFA selected
                    </div>
                </div>
                <h2 style="margin:0; text-align:center;">ADD TRANSITION</h2>
            </div>
            <form asp-controller="AutomatonCreation" asp-action="AddTransition" method="post" style="padding:1rem;">
                @Html.HiddenFor(m => m.Type)
                @if (Model?.States != null)
                {
                    @for (int i = 0; i < Model.States.Count; i++)
                    {
                        <input type="hidden" name="States[@i].Id" value="@Model.States[i].Id" />
                        <input type="hidden" name="States[@i].IsStart" value="@Model.States[i].IsStart.ToString().ToLowerInvariant()" />
                        <input type="hidden" name="States[@i].IsAccepting" value="@Model.States[i].IsAccepting.ToString().ToLowerInvariant()" />
                    }
                }
                @if (Model?.Transitions != null)
                {
                    @for (int i = 0; i < Model.Transitions.Count; i++)
                    {
                        <input type="hidden" name="Transitions[@i].FromStateId" value="@Model.Transitions[i].FromStateId" />
                        <input type="hidden" name="Transitions[@i].ToStateId" value="@Model.Transitions[i].ToStateId" />
                        <input type="hidden" name="Transitions[@i].Symbol" value="@Model.Transitions[i].Symbol" />
                        @if (Model.Type == AutomatonType.PDA)
                        {
                            <input type="hidden" name="Transitions[@i].StackPop" value="@Model.Transitions[i].StackPop" />
                            <input type="hidden" name="Transitions[@i].StackPush" value="@Model.Transitions[i].StackPush" />
                        }
                    }
                }
                <div style="display:flex; flex-direction:column; gap:0.75rem;">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:0.5rem;">
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="font-weight:600;">From State:</label>
                            <input type="number" name="fromStateId" class="control-btn" style="padding:0.5rem 0.75rem;" required min="0" />
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="font-weight:600;">Symbol:</label>
                                <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" name="symbol" class="control-btn" style="padding:0.5rem 0.75rem;" required maxlength="1" placeholder="a or ε" />
                                <button type="button" class="epsilon-btn control-btn" style="min-width:3.25rem; padding:0.4rem; display:none;" title="Insert ε">ε</button>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="font-weight:600;">To State:</label>
                            <input type="number" name="toStateId" class="control-btn" style="padding:0.5rem 0.75rem;" required min="0" />
                        </div>
                    </div>
                    @if (Model?.Type == AutomatonType.PDA)
                    {
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">
                            <div style="display:flex; flex-direction:column; gap:0.25rem;">
                                <label style="font-weight:600;">Stack Pop:</label>
                                <input type="text" name="newTransitionStackPop" class="control-btn" style="padding:0.5rem 0.75rem;" maxlength="1" placeholder="Optional" />
                            </div>
                            <div style="display:flex; flex-direction:column; gap:0.25rem;">
                                <label style="font-weight:600;">Stack Push:</label>
                                <input type="text" name="newTransitionStackPush" class="control-btn" style="padding:0.5rem 0.75rem;" placeholder="Optional" />
                            </div>
                        </div>
                    }
                    <button type="submit" class="control-btn" style="width:100%; margin-top:0.5rem;">Add Transition</button>
                </div>
            </form>
        </div>

        <!-- Remove Transition Section -->
        <div class="control-section" style="grid-column: span 2;">
            <div class="section-header-custom" style="position:relative; padding-right:2.5rem;">
                <div class="epsilon-info" style="position:absolute; left:0; top:50%; transform:translateY(-50%); display:none;">
                    <span class="info-btn" aria-label="Epsilon info" title="Alt+E: insert ε" style="display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; font-size:1.15rem; color:var(--bs-body-color); background:transparent; border:none; box-shadow:none; cursor:pointer; padding-left:1rem;">
                        <i class="fas fa-info-circle" aria-hidden="true" style="font-size:1.25rem"></i>
                    </span>
                    <div class="info-tooltip" style="display:none; position:absolute; left:calc(100% + 8px); top:50%; transform:translateY(-50%); background:#222; color:#fff; padding:6px 8px; border-radius:4px; white-space:nowrap; font-size:0.85rem;">
                        Alt+E inserts 'ε' when ε-NFA selected
                    </div>
                </div>
                <h2 style="margin:0; text-align:center;">REMOVE TRANSITION</h2>
            </div>
            <form asp-controller="AutomatonCreation" asp-action="RemoveTransition" method="post" style="padding:1rem;">
                @Html.HiddenFor(m => m.Type)
                @if (Model?.States != null)
                {
                    @for (int i = 0; i < Model.States.Count; i++)
                    {
                        <input type="hidden" name="States[@i].Id" value="@Model.States[i].Id" />
                        <input type="hidden" name="States[@i].IsStart" value="@Model.States[i].IsStart.ToString().ToLowerInvariant()" />
                        <input type="hidden" name="States[@i].IsAccepting" value="@Model.States[i].IsAccepting.ToString().ToLowerInvariant()" />
                    }
                }
                @if (Model?.Transitions != null)
                {
                    @for (int i = 0; i < Model.Transitions.Count; i++)
                    {
                        <input type="hidden" name="Transitions[@i].FromStateId" value="@Model.Transitions[i].FromStateId" />
                        <input type="hidden" name="Transitions[@i].ToStateId" value="@Model.Transitions[i].ToStateId" />
                        <input type="hidden" name="Transitions[@i].Symbol" value="@Model.Transitions[i].Symbol" />
                        @if (Model.Type == AutomatonType.PDA)
                        {
                            <input type="hidden" name="Transitions[@i].StackPop" value="@Model.Transitions[i].StackPop" />
                            <input type="hidden" name="Transitions[@i].StackPush" value="@Model.Transitions[i].StackPush" />
                        }
                    }
                }
                <div style="display:flex; flex-direction:column; gap:0.75rem;">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:0.5rem;">
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="font-weight:600;">From State:</label>
                            <input type="number" name="fromStateId" class="control-btn" style="padding:0.5rem 0.75rem;" required min="0" />
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="font-weight:600;">Symbol:</label>
                                <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="text" name="symbol" class="control-btn" style="padding:0.5rem 0.75rem;" required maxlength="1" placeholder="a or ε" />
                                <button type="button" class="epsilon-btn control-btn" style="min-width:3.25rem; padding:0.4rem; display:none;" title="Insert ε">ε</button>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="font-weight:600;">To State:</label>
                            <input type="number" name="toStateId" class="control-btn" style="padding:0.5rem 0.75rem;" required min="0" />
                        </div>
                    </div>
                    <button type="submit" class="control-btn" style="width:100%; margin-top:0.5rem;">Remove Transition</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Final Submit Section -->
    <div class="control-sections">
        <div class="control-section" style="grid-column: span 4;">
            <div class="section-header-custom">
                <h2>FINISH</h2>
            </div>
            <form asp-controller="AutomatonCreation" asp-action="CreateAutomaton" method="post" style="padding:1rem;">
                @Html.HiddenFor(m => m.Type)
                @if (Model?.States != null)
                {
                    @for (int i = 0; i < Model.States.Count; i++)
                    {
                        <input type="hidden" name="States[@i].Id" value="@Model.States[i].Id" />
                        <input type="hidden" name="States[@i].IsStart" value="@Model.States[i].IsStart.ToString().ToLowerInvariant()" />
                        <input type="hidden" name="States[@i].IsAccepting" value="@Model.States[i].IsAccepting.ToString().ToLowerInvariant()" />
                    }
                }
                @if (Model?.Transitions != null)
                {
                    @for (int i = 0; i < Model.Transitions.Count; i++)
                    {
                        <input type="hidden" name="Transitions[@i].FromStateId" value="@Model.Transitions[i].FromStateId" />
                        <input type="hidden" name="Transitions[@i].ToStateId" value="@Model.Transitions[i].ToStateId" />
                        <input type="hidden" name="Transitions[@i].Symbol" value="@Model.Transitions[i].Symbol" />
                        @if (Model.Type == AutomatonType.PDA)
                        {
                            <input type="hidden" name="Transitions[@i].StackPop" value="@Model.Transitions[i].StackPop" />
                            <input type="hidden" name="Transitions[@i].StackPush" value="@Model.Transitions[i].StackPush" />
                        }
                    }
                }
                <div style="display:flex; gap:1rem; justify-content:center;">
                    <button type="submit" class="control-btn" style="min-width:200px; font-size:1.1rem; padding:0.75rem 1.5rem;">
                        <i class="fas fa-check-circle"></i>
                        <span>Create Automaton</span>
                    </button>
                    <a href="@Url.Action("Index", "Home")" class="control-btn" style="min-width:200px; font-size:1.1rem; padding:0.75rem 1.5rem; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:0.5rem;">
                        <i class="fas fa-times-circle"></i>
                        <span>Cancel</span>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/canvas.js" asp-append-version="true"></script>
    <script>
        // Symbol input helpers and epsilon shortcut — active only for ε-NFA (typeField === 2)
        (function(){
            function insertEpsilonAtCaret(input){
                const s = input.selectionStart ?? 0;
                const t = input.selectionEnd ?? s;
                input.value = input.value.slice(0, s) + 'ε' + input.value.slice(t);
                input.selectionStart = input.selectionEnd = s + 1;
            }

            function symbolKeyHandler(e){
                // Alt+E inserts epsilon only when epsilon NFA is selected
                if (!e.altKey) return;
                const key = (e.key || '').toLowerCase?.() || '';
                if (key !== 'e') return;
                const typeField = document.getElementById('typeField');
                const typeVal = typeField ? parseInt(typeField.value || '0', 10) : 0;
                if (typeVal !== 2) return; // only for ε-NFA
                if (!(e.target && e.target.tagName && e.target.tagName.toLowerCase() === 'input')) return;
                e.preventDefault();
                insertEpsilonAtCaret(e.target);
            }

            function attachSymbolKeyHandlers(){
                document.querySelectorAll('input[name="symbol"]').forEach(input => {
                    input.removeEventListener('keydown', symbolKeyHandler);
                    input.addEventListener('keydown', symbolKeyHandler);
                });
            }

            function updateSymbolPlaceholders() {
                const typeField = document.getElementById('typeField');
                const typeVal = typeField ? parseInt(typeField.value || '0', 10) : 0;
                const placeholder = (typeVal === 2) ? 'a or ε' : 'a';
                document.querySelectorAll('input[name="symbol"]').forEach(i => i.setAttribute('placeholder', placeholder));
                // Show epsilon insert button and hint only for EpsilonNFA
                document.querySelectorAll('.epsilon-btn').forEach(btn => btn.style.display = (typeVal === 2) ? 'inline-flex' : 'none');
                // Show the left-aligned info helper next to the section title when in ε-NFA
                document.querySelectorAll('.epsilon-info').forEach(wrapper => wrapper.style.display = (typeVal === 2) ? 'inline-block' : 'none');
            }

            // Insert epsilon when epsilon button clicked
            function attachEpsilonButtons(){
                document.querySelectorAll('.epsilon-btn').forEach(btn => {
                    btn.removeEventListener('click', onEpsilonClick);
                    btn.addEventListener('click', onEpsilonClick);
                });
            }
            function onEpsilonClick(e){
                // find nearest input[name="symbol"] sibling
                const btn = e.currentTarget;
                const container = btn.parentElement;
                if (!container) return;
                const input = container.querySelector('input[name="symbol"]');
                if (!input) return;
                insertEpsilonAtCaret(input);
                input.focus();
            }

            // Initialize on load
            document.addEventListener('DOMContentLoaded', () => {
                updateSymbolPlaceholders();
                attachEpsilonButtons();
                attachSymbolKeyHandlers();
                // Update placeholders when type buttons are clicked (client-side feedback)
                document.querySelectorAll('.type-btn').forEach(b => b.addEventListener('click', () => setTimeout(updateSymbolPlaceholders, 0)));
                // Tooltip behavior for info buttons
                document.querySelectorAll('.epsilon-info').forEach(wrapper => {
                    const btn = wrapper.querySelector('.info-btn');
                    const tip = wrapper.querySelector('.info-tooltip');
                    if (!btn || !tip) return;
                    wrapper.addEventListener('mouseenter', () => { tip.style.display = 'block'; });
                    wrapper.addEventListener('mouseleave', () => { tip.style.display = 'none'; });
                    // Also click focuses the nearest symbol input (convenience)
                    btn.addEventListener('click', () => {
                        const formSection = wrapper.closest('.control-section');
                        if (!formSection) return;
                        const input = formSection.querySelector('input[name="symbol"]');
                        if (input) input.focus();
                    });
                });
                // Update placeholders when type buttons are clicked (client-side feedback)
                document.querySelectorAll('.type-btn').forEach(b => b.addEventListener('click', () => setTimeout(updateSymbolPlaceholders, 0)));
            });

            // If the hidden type field is changed via script, update placeholders
            const tf = document.getElementById('typeField');
            if (tf) tf.addEventListener('change', () => { updateSymbolPlaceholders(); });
        })();
    </script>
}
